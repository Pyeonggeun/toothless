<?xml version="1.0" encoding="UTF-8"?>
<!-- 아래 코드를 넣음으로 URL로 접속하여 dtd를 다운받고 필요기능들을 가져옴 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mkfactory.toothless.e.registercounselor.mapper.RegisterCounselorSqlMapper">

	<!-- 외부사용자 PK생성 -->
	<select id="createExternalPk" resultType="int">
		SELECT tl_jic_external_info_seq.nextval FROM dual
	</select>
	
	<!-- 공통 외부사용자 테이블 insert-->
	<insert id="insertExternalInfo">
		INSERT INTO tl_jic_external_info VALUES(
			#{external_pk},
			#{external_id},
			#{password},
			3,
			SYSDATE
		)
	</insert>
	
	<!-- 상담원 PK 생성 -->
	<select id="createCounselorPk" resultType="int">
		SELECT cp_counselor_seq.nextval FROM dual
	</select>
	
	<!-- 상담원 신규 등록 -->
	<insert id="insertCounselor">
		INSERT INTO CP_COUNSELOR cc VALUES (
			#{id},
			#{external_pk},
			#{name},
			#{age},
			#{gender},
			#{phonenumber},
			#{email},
			#{address},
			#{career},
			#{profileImage},
			SYSDATE
		)	
	</insert>
	
	<!-- 상담원 전체 리스팅 -->
	<select id="selectAllCounselor" resultType="map">
		SELECT 
			cc.id AS id,
			cct.type_category_id AS typecategory,
			cc.name AS name,
			cc.age AS age,
			cc.GENDER AS gender,
			cc.PHONENUMBER AS phonenumber,
			cc.EMAIL AS email,
			cc.address AS address,
			cc.CAREER AS career,
			cc.PROFILEIMAGE AS profileImage
		FROM CP_COUNSELOR_TYPE cct
		INNER JOIN CP_COUNSELOR cc ON cc.id = cct.counselor_id
		ORDER BY type_category_id ASC
	</select>
	
	<!-- 상담원 전체 중복제거 리스팅 for AJAX -->
	<select id="selectAllCounselorForAJAX" resultType="map">
		SELECT *
		FROM(
		SELECT
			ROW_NUMBER () OVER (PARTITION BY mainView.counselorId ORDER BY mainView.category) mainRn,
			mainView.category AS category,	
			mainView.counselorId AS counselorId,
			mainView.name AS name,
			mainView.age AS age,
			mainView.gender AS gender,
			mainView.phonenumber AS phonenumber,
			mainView.email AS email,
			mainView.address AS address,
			mainView.career AS career,
			mainView.profileimage AS profileImage,
			mainView.scoreAvg AS scoreAvg
		FROM (
		SELECT
			counselorTB.rn AS rn,
			counselorTB.category AS category,
			counselorTB.id AS counselorId,
			counselorTB.name AS name,
			counselorTB.age AS age,
			counselorTB.gender AS gender,
			counselorTB.phonenumber AS phonenumber,
			counselorTB.email AS email,
			counselorTB.address AS address,
			counselorTB.career AS career,
			counselorTB.profileimage AS profileImage,
			nvl(scoreTB.scoreAvg, 0) AS scoreAvg
		FROM (
			SELECT 
				ROW_NUMBER () OVER (PARTITION BY cct.TYPE_CATEGORY_ID ORDER BY cc.id ASC) rn,
				cct.TYPE_CATEGORY_ID AS category,
				cc.*
			FROM CP_COUNSELOR_TYPE cct
			INNER JOIN CP_COUNSELOR cc ON cc.id = cct.counselor_id
			) counselorTB
		LEFT JOIN (
			SELECT 
			counselor_id,
			avg(scoreAvg) AS scoreAvg
			FROM (
				SELECT
					cgc2.COUNSELOR_ID AS counselor_id,
					avg(cgs.SCORE) AS scoreAvg
				FROM CP_GROUP_SURVEY cgs
				INNER JOIN CP_GROUP_RESERVATION cgr ON cgr.ID = cgs.GROUP_RESERVATION_ID
				INNER JOIN CP_GROUP_COUNSEL cgc ON cgc.id = cgr.GROUP_COUNSEL_ID
				INNER JOIN CP_GROUP_COUNSELOR cgc2 ON cgc2.GROUP_COUNSEL_ID = cgc.id
				GROUP BY cgc2.COUNSELOR_ID
				UNION
				SELECT 
					cor.COUNSELOR_ID AS counselor_id,
					avg(coss.SCORE) AS scoreAvg
				FROM CP_OFFLINE_RESERVATION cor
				INNER JOIN CP_OFFLINE_SURVEY coss ON coss.RESERVATION_ID = cor.id
				GROUP BY cor.COUNSELOR_ID 
				UNION	
				SELECT 
					counselor_id,
					scoreAvg
				FROM (
					SELECT 
						cocr.counselor_id AS counselor_id,
						avg(cocs.SCORE) AS scoreAvg
					FROM CP_ONLINE_COUNSEL_SURVEY cocs
					INNER JOIN CP_ONLINE_COUNSEL_BOARD cocb ON cocb.id = cocs.ONLINE_COUNSEL_BOARD_ID
					INNER JOIN CP_ONLINE_COUNSEL_REPLY cocr ON cocb.ID = cocr.ONLINE_COUNSEL_BOARD_ID
					GROUP BY cocr.counselor_id
					) 
				)
				GROUP BY counselor_id
				ORDER BY counselor_id asc
			) scoreTB ON counselorTB.id = scoreTB.counselor_id			
		<choose>
			<when test="searchOption == true">			
				WHERE 1 = 1		
				<if test="!searchCounselorName.equals('default')">
					AND name LIKE '%' || #{searchCounselorName} || '%'				
				</if>
				<if test="searchCounselorType != null and searchCounselorType.length > 0">
					AND category IN
					<foreach collection="searchCounselorType" item="type" open="(" separator="," close=")">
						#{type}
					</foreach>						
				</if>
				<if test="!searchGenderOption.equals('default')">
					AND gender = #{searchGenderOption}
				</if>								
				
				<!-- <if test="searchOption == true and !searchCounselorName.equals('default')">
					and rn = 1
				</if>
				<if test="
					searchOption == true and
					searchCounselorName.equals('default') and
					searchCounselorType != null and searchCounselorType.length == 0 and
					!searchGenderOption.equals('default')
					">
					and rn = 1
				</if>
				<if test="
					searchOption == true and
					searchCounselorName.equals('default') and
					searchCounselorType != null and searchCounselorType.length == 0 and
					searchGenderOption.equals('default') and
					!searchScoreOption.equals('default')
					">
					and rn = 1
				</if>
				<if test="
					searchOption == true and
					searchCounselorName.equals('default') and
					searchCounselorType != null and searchCounselorType.length == 0 and
					!searchGenderOption.equals('default') and
					!searchScoreOption.equals('default')
					">
					and rn = 1
				</if> -->				
			</when>
		</choose>
		) mainView
		) ranked
		WHERE mainrn = 1
		<if test="!searchScoreOption.equals('default') and !searchScoreOption.equals('scoreASC')">			
			ORDER BY SCOREAVG ASC
		</if>
		<if test="!searchScoreOption.equals('default') and !searchScoreOption.equals('scoreDESC')">
			ORDER BY SCOREAVG DESC
		</if>		
	</select>
	
	<!-- 상담원 PK로 상담원정보 조회 -->
	<select id="selectCounselorDetailByCounselorId" resultType="com.mkfactory.toothless.e.dto.CounselorDto">
		SELECT * FROM CP_COUNSELOR WHERE id = #{id}
	</select>
	
	<!-- 상담카테고리 리스팅 -->
	<select id="selectAllTypeCategory" resultType="com.mkfactory.toothless.e.dto.TypeCategoryDto">
		SELECT * FROM cp_type_category
	</select>
	
	<!-- 상담원별 담당카테고리 정보 인서트 -->
	<insert id="insertCounselorType">
		INSERT INTO cp_counselor_type VALUES (
			cp_counselor_type_seq.nextval,
			#{counselor_id},
			#{type_category_id},
			SYSDATE
		)
	</insert>
	
	<!-- 상담원PK로 담당카테고리 정보 셀렉트 -->
	<select id="selectCounselorTypeByCounselorId" resultType="map">
		SELECT 
			cct.TYPE_CATEGORY_ID AS id,
			ctc.NAME AS categoryname
		FROM CP_COUNSELOR_TYPE cct
		INNER JOIN CP_TYPE_CATEGORY ctc ON ctc.id = cct.TYPE_CATEGORY_ID  
		WHERE COUNSELOR_ID = #{id}
	</select>
	
	<!-- 상담원 자격증 이미지 등록 -->
	<insert id="insertLicenseImage">
		INSERT INTO cp_license_image VALUES(
			cp_license_image_seq.nextval,
			#{counselor_id},
			#{license}
		)
	</insert>
	
	<!-- 상담원PK로 상담원 자격증 이미지 리스팅 -->
	<select id="selectLicenseImgByCounselorId" resultType="com.mkfactory.toothless.e.dto.LicenseImageDto">
		SELECT * FROM cp_license_image
		WHERE counselor_id = #{counselor_id} 
	</select>
	
	<!-- 상담사PK로 상담사 오프라인 평점현황 조회 -->
	<select id="selectOfflineSurveyScoreByCounselorId" resultType="map">
		SELECT 
			cor.COUNSELOR_ID AS counselor,
			count(CASE WHEN coss.SCORE = 1 THEN 1 end) AS score1,
			count(CASE WHEN coss.SCORE = 2 THEN 1 end) AS score2,
			count(CASE WHEN coss.SCORE = 3 THEN 1 end) AS score3,
			count(CASE WHEN coss.SCORE = 4 THEN 1 end) AS score4,
			count(CASE WHEN coss.SCORE = 5 THEN 1 end) AS score5
		FROM CP_OFFLINE_RESERVATION cor
		INNER JOIN CP_OFFLINE_SURVEY coss ON coss.RESERVATION_ID = cor.id
		GROUP BY cor.COUNSELOR_ID HAVING cor.COUNSELOR_ID = #{counserlor_id}
	</select>
	
	<!-- 상담사PK로 오프라인상담 완료현황 조회 -->
	<select id="selectCompleteOfflineCounselListByCounselorId" resultType="map">
		SELECT 
			cor.id AS ID,
			ctc.name AS category,
			cor.COUNSEL_YEAR AS cYEAR,
			cor.COUNSEL_MONTH AS cMONTH,
			cor.COUNSEL_DATE AS cdate
		FROM CP_OFFLINE_RESERVATION cor
		INNER JOIN CP_TYPE_CATEGORY ctc ON ctc.ID = cor.TYPE_CATEGORY_ID 
		WHERE 1=1
		AND STATE = '완료'
		AND COUNSELOR_ID = #{counselor_id}
		ORDER BY id ASC
	</select>
	
	<!-- 상담사PK로 오프라인상담 평점 조회 -->
	<select id="selectOfflineCounselScoreAvg" resultType="double">
		SELECT avg(coss.score) AS scoreAvg
		FROM CP_OFFLINE_RESERVATION cor
		INNER JOIN CP_OFFLINE_SURVEY coss ON coss.RESERVATION_ID = cor.id
		WHERE cor.COUNSELOR_ID = #{counselor_id}
	</select>
	
	<!-- 상담원 신규등록시 중복확인 -->
	<select id="checkDuplicationExternalId" resultType="int">
		SELECT count(*) FROM TL_JIC_EXTERNAL_INFO		
		WHERE EXTERNAL_ID LIKE #{inputId}
	</select>
	
	<!-- 상담원PK로 해당 상담사가 완료한 상담리스트 및 참여한 집단상담리스트 -->
	<select id="selectCompleteCounselListByCounselorId" resultType="map">
		SELECT
			cc.id AS counselorId,
			completeList.boardType AS counselBoardType,
			completeList.counselNo AS counselNo,
			completeList.counselType AS counselType,
			completeList.counselDate AS counselDate
		FROM CP_COUNSELOR cc
		INNER JOIN (
				SELECT
				1 AS boardType,
				cor.COUNSELOR_ID AS counselorId, 
				cor.id AS counselNo,
				ctc.NAME AS counselType,
				cor.COUNSEL_YEAR || '-' ||cor.COUNSEL_MONTH || '-' || cor.COUNSEL_DAY AS counselDate
			FROM CP_OFFLINE_RESERVATION cor
			INNER JOIN CP_COUNSELOR cc ON cc.id = cor.COUNSELOR_ID
			INNER JOIN CP_TYPE_CATEGORY ctc ON cor.TYPE_CATEGORY_ID = ctc.ID 
			WHERE cor.STATE = '완료'
			UNION 
			SELECT
				2 AS boardType,
				cocr.COUNSELOR_ID AS counselorId,
				cocb.id AS counselNo,
				ctc.NAME AS counselType,
				TO_CHAR(cocb.CREATED_AT, 'yyyy-MM-dd') AS counselDate 
			FROM CP_ONLINE_COUNSEL_BOARD cocb
			INNER JOIN CP_ONLINE_COUNSEL_REPLY cocr ON cocr.ONLINE_COUNSEL_BOARD_ID = cocb.ID
			INNER JOIN CP_TYPE_CATEGORY ctc ON cocb.TYPE_CATEGORY_ID = ctc.ID
			UNION
			SELECT
				3 AS boardType,
				cgc2.COUNSELOR_ID AS counselorId,
				cgc.ID AS counselNo,
				cgc.TITLE AS counselType,
				TO_CHAR(cgc.COUNSEL_DATE, 'yyyy-mm-dd') AS counselDate  
			FROM CP_GROUP_RESERVATION cgr
			INNER JOIN CP_GROUP_COUNSEL cgc ON cgc.ID = cgr.GROUP_COUNSEL_ID
			INNER JOIN CP_GROUP_COUNSELOR cgc2 on cgc.ID = cgc2.GROUP_COUNSEL_ID
			) completeList ON completeList.counselorid = cc.ID
		WHERE id = #{counselorId}
	</select>
	
	<!-- 미친짓 : 상담사PK기준 카테고리별 평균평점+전체평균평점+별점항목별 갯수 카운팅 -->
	<select id="selectTotalScoreInfoByCounselorId" resultType="map">
		SELECT
			cc2.ID AS counselorId,
			nvl(mainView.offAvg,0) AS offAvg,
			nvl(mainView.onAvg,0) AS onAvg,
			nvl(mainView.groupAvg,0) AS groupAvg,
			nvl(mainView.totalAvg,0) AS totalAvg,
			starRateView.score1 AS score1,
			starRateView.score2 AS score2,
			starRateView.score3 AS score3,
			starRateView.score4 AS score4,
			starRateView.score5 AS score5
		FROM CP_COUNSELOR cc2
		LEFT OUTER JOIN (
			SELECT 
				totalAvgView.counselorID AS counselorId,
				AVG(categoryAvgView.offavg) AS offAvg,
				AVG(categoryAvgView.onAvg) AS onAvg,
				AVG(categoryAvgView.groupAvg) AS groupAvg,
				TRUNC(AVG(totalAvgView.score),2) AS totalAvg
			FROM (
				SELECT 	
					cor.counselor_id AS counselorId,
					cos2.SCORE AS score
				FROM CP_OFFLINE_RESERVATION cor 
				INNER JOIN CP_OFFLINE_SURVEY cos2 ON cos2.RESERVATION_ID = cor.id
				WHERE cor.STATE = '완료'
				UNION ALL 
				SELECT
					cocr.COUNSELOR_ID AS counselorId,
					cocs.SCORE AS score
				FROM CP_ONLINE_COUNSEL_SURVEY cocs
				INNER JOIN CP_ONLINE_COUNSEL_BOARD cocb ON cocb.ID = cocs.ONLINE_COUNSEL_BOARD_ID
				INNER JOIN CP_ONLINE_COUNSEL_REPLY cocr ON cocr.ONLINE_COUNSEL_BOARD_ID = cocb.ID 
				UNION ALL  
				SELECT
					cgc2.COUNSELOR_ID AS counselorId,
					cgs.SCORE AS score
				FROM CP_GROUP_SURVEY cgs 
				INNER JOIN CP_GROUP_RESERVATION cgr ON cgr.ID = cgs.GROUP_RESERVATION_ID
				INNER JOIN CP_GROUP_COUNSEL cgc ON cgc.ID = cgr.group_counsel_id
				INNER JOIN CP_GROUP_COUNSELOR cgc2 ON cgc2.GROUP_COUNSEL_ID = cgc.ID
				) totalAvgView
			INNER JOIN (
				SELECT
					cc.id AS counselorId,
					nvl(offlineData.offlineAvg,0) AS offAvg,
					nvl(onlineData.onlineAvg,0) AS onAvg,
					nvl(TRUNC(groupData.groupAvg, 2),0) AS groupAvg	
				FROM CP_COUNSELOR cc 
				LEFT OUTER JOIN (
					SELECT 	
					max(cor.counselor_id) AS counselorId,
					nvl(avg(cos2.SCORE),0) AS offlineAvg
					FROM CP_OFFLINE_RESERVATION cor 
					INNER JOIN CP_OFFLINE_SURVEY cos2 ON cos2.RESERVATION_ID = cor.id
					WHERE cor.STATE = '완료' 
					GROUP by cor.counselor_id
					) offlineData ON cc.ID = offlineData.counselorId
				LEFT OUTER JOIN (
					SELECT
					max(cocr.COUNSELOR_ID) AS counselorId,
					nvl(avg(cocs.SCORE),0) AS onlineAvg
					FROM CP_ONLINE_COUNSEL_SURVEY cocs
					INNER JOIN CP_ONLINE_COUNSEL_BOARD cocb ON cocb.ID = cocs.ONLINE_COUNSEL_BOARD_ID
					INNER JOIN CP_ONLINE_COUNSEL_REPLY cocr ON cocr.ONLINE_COUNSEL_BOARD_ID = cocb.ID 
					GROUP BY cocr.COUNSELOR_ID
					) onlineData ON cc.ID = onlineData.counselorId
				LEFT OUTER JOIN (
					SELECT
					max(cgc2.COUNSELOR_ID) AS counselorId,
					nvl(avg(cgs.SCORE),0) AS groupAvg
					FROM CP_GROUP_SURVEY cgs 
					INNER JOIN CP_GROUP_RESERVATION cgr ON cgr.ID = cgs.GROUP_RESERVATION_ID
					INNER JOIN CP_GROUP_COUNSEL cgc ON cgc.ID = cgr.group_counsel_id
					INNER JOIN CP_GROUP_COUNSELOR cgc2 ON cgc2.GROUP_COUNSEL_ID = cgc.ID 
					GROUP BY cgc2.COUNSELOR_ID 
					) groupData ON cc.ID = groupData.counselorId
				) categoryAvgView ON categoryAvgView.counselorId = totalAvgView.counselorId
			GROUP BY totalAvgView.counselorId
			ORDER BY totalAvgView.counselorId ASC
			) mainView ON mainView.counselorId = cc2.ID 
		INNER JOIN (
			SELECT
				cc.ID AS counselorID,
				nvl(sum(rateBoard.score1),0) AS score1,
				nvl(sum(rateBoard.score2),0) AS score2,
				nvl(sum(rateBoard.score3),0) AS score3,
				nvl(sum(rateBoard.score4),0) AS score4,
				nvl(sum(rateBoard.score5),0) AS score5
			FROM CP_COUNSELOR cc 
			LEFT OUTER JOIN (
				SELECT
					cgc2.COUNSELOR_ID AS counselorId,
					COUNT(CASE WHEN cgs.SCORE=1 THEN 1 END) AS SCORE1, 
					COUNT(CASE WHEN cgs.SCORE=2 THEN 1 END) AS SCORE2, 
					COUNT(CASE WHEN cgs.SCORE=3 THEN 1 END) AS SCORE3, 
					COUNT(CASE WHEN cgs.SCORE=4 THEN 1 END) AS SCORE4, 
					COUNT(CASE WHEN cgs.SCORE=5 THEN 1 END) AS SCORE5 
				FROM CP_GROUP_SURVEY cgs
				INNER JOIN CP_GROUP_RESERVATION cgr ON cgs.GROUP_RESERVATION_ID = cgr.ID 
				INNER JOIN CP_GROUP_COUNSEL cgc ON cgc.ID = cgr.GROUP_COUNSEL_ID 
				INNER JOIN CP_GROUP_COUNSELOR cgc2 ON cgc2.GROUP_COUNSEL_ID = cgc.ID
				GROUP BY cgc2.COUNSELOR_ID 
				UNION 
				SELECT
					cocr.COUNSELOR_ID AS counselorId,
					COUNT(CASE WHEN cocs.SCORE=1 THEN 1 END) AS score1,
					COUNT(CASE WHEN cocs.SCORE=2 THEN 1 END) AS score2,
					COUNT(CASE WHEN cocs.SCORE=3 THEN 1 END) AS score3,
					COUNT(CASE WHEN cocs.SCORE=4 THEN 1 END) AS score4,
					COUNT(CASE WHEN cocs.SCORE=5 THEN 1 END) AS score5
				FROM CP_ONLINE_COUNSEL_SURVEY cocs
				INNER JOIN CP_ONLINE_COUNSEL_BOARD cocb ON cocb.ID = cocs.ONLINE_COUNSEL_BOARD_ID 
				INNER JOIN CP_ONLINE_COUNSEL_REPLY cocr ON cocr.ONLINE_COUNSEL_BOARD_ID = cocb.ID
				GROUP BY cocr.COUNSELOR_ID 
				UNION 
				SELECT
					cor.COUNSELOR_ID AS counselorId,
					COUNT(CASE WHEN cos2.SCORE=1 THEN 1 END) AS score1,
					COUNT(CASE WHEN cos2.SCORE=2 THEN 1 END) AS score2,
					COUNT(CASE WHEN cos2.SCORE=3 THEN 1 END) AS score3,
					COUNT(CASE WHEN cos2.SCORE=4 THEN 1 END) AS score4,
					COUNT(CASE WHEN cos2.SCORE=5 THEN 1 END) AS score5
				FROM CP_OFFLINE_SURVEY cos2
				INNER JOIN CP_OFFLINE_RESERVATION cor ON cor.ID = cos2.RESERVATION_ID
				GROUP BY cor.COUNSELOR_ID
				)rateBoard ON rateBoard.counselorId = cc.ID
			GROUP BY cc.ID
			) starRateView ON starRateView.counselorId = cc2.ID 
		WHERE cc2.ID = #{counselorId}
	</select>
	
	
	

</mapper>